name: Deploy to Server (Push Sync)

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: deploy-project-main
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup SSH
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "${{ secrets.DEPLOY_HOST }}" >> ~/.ssh/known_hosts

      - name: Sync files to server (rsync)
        shell: bash
        run: |
          set -euo pipefail

          # 目标：你截图里的目录
          TARGET_DIR="/home/admin/www/project-main"

          # rsync 说明：
          # -a 归档模式（保留时间戳等）
          # -z 压缩传输
          # --delete 让服务器目录与仓库完全一致（仓库删了服务器也删）
          # --exclude 排除不应部署的东西
          rsync -az --delete \
            --exclude ".git/" \
            --exclude ".github/" \
            --exclude ".idea/" \
            --exclude "node_modules/" \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=yes" \
            ./ "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:${TARGET_DIR}/"

      # 如果你用 nginx/其他服务托管静态文件，一般不需要重启。
      # 若你确实需要 reload（例如用到缓存规则变更），取消注释下面这段。
      # - name: Optional - reload nginx
      #   uses: appleboy/ssh-action@v1.0.3
      #   with:
      #     host: ${{ secrets.DEPLOY_HOST }}
      #     username: ${{ secrets.DEPLOY_USER }}
      #     key: ${{ secrets.DEPLOY_SSH_KEY }}
      #     script: |
      #       sudo nginx -s reload
